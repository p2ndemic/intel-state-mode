#!/bin/bash
# =============================================
# Intel P-State helper: Helper script to dynamically change Intel P-state parameters
# =============================================
# Ref: https://docs.kernel.org/admin-guide/pm/intel_pstate.html
# Ref: https://www.clearlinux.org/clear-linux-documentation/guides/maintenance/cpu-performance.html
# Ref: https://docs.mesa3d.org/perf.html
# =============================================
# → Installation: 
# → Create a file: sudo nano /usr/local/bin/intel-pstate-helper
# → Make the script executable: sudo chmod +x /usr/local/bin/intel-pstate-helper
# =============================================
# → Create systemd daemons:
# → See: https://github.com/p2ndemic/dotfiles/tree/main/etc/systemd/system
# =============================================
# → Enable default service for autostart:
# sudo systemctl enable --now intel-pstate-default.service && sudo systemctl daemon-reload
# =============================================
# → Additional installation:
# → Install thermald: sudo pacman -S thermald && systemctl enable --now thermald
# =============================================
# → Remove power-profiles-daemon:
# sudo pacman -Rns power-profiles-daemon
# =============================================
# → Install tuned:
# sudo pacman -S tuned && systemctl enable --now tuned
# =============================================
# → Testing:
# → Check current CPU power mode settings:
# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_driver | head -1
# cat /sys/devices/system/cpu/intel_pstate/status
# cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor | head -1
# cat /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference | head -1
# cat /sys/devices/system/cpu/intel_pstate/no_turbo
# cat /sys/devices/system/cpu/intel_pstate/hwp_dynamic_boost
# cat /sys/devices/system/cpu/intel_pstate/min_perf_pct
# cat /sys/devices/system/cpu/intel_pstate/max_perf_pct
# cat /sys/devices/system/cpu/intel_pstate/energy_efficiency
# cat /sys/devices/system/cpu/smt/control
# =============================================
# → Test the helper script directly:
# sudo intel-pstate-helper --governor performance --epp balance_power --no-turbo 0 --hwp-dynamic-boost 0 --min-perf-pct 10  --max-perf-pct 75 --nosmt on
# =============================================

# Function to show usage information
show_usage() {
    echo "Usage: $0 [OPTIONS]"
    echo "Options:"
    echo "  --governor <value>            Set CPU governor (e.g., powersave, performance)"
    echo "  --epp <value>                 Set energy performance preference (e.g., balance_performance, performance)"
    echo "  --no-turbo <0 | 1>            Enable/disable Turbo-Boost (0=enable, 1=disable)"
    echo "  --hwp-dynamic-boost <0 | 1>   Enable/disable HWP Dynamic Boost (0=disable, 1=enable)"
    echo "  --min-perf-pct <value>        Set minimum performance percentage (0-100)"
    echo "  --max-perf-pct <value>        Set maximum performance percentage (0-100)"
    echo "  --nosmt <on | off>            Enable/disable SMT (Hyper-Threading)"
    echo "  --help                        Show this help message"
}

# Initialize all variables
GOVERNOR=""
EPP=""
NO_TURBO=""
HWP_DYNAMIC_BOOST=""
MIN_PERF_PCT=""
MAX_PERF_PCT=""
ENERGY_EFFICIENCY=""
NOSMT=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --governor)
            GOVERNOR="$2"
            shift
            shift
            ;;
        --epp)
            EPP="$2"
            shift
            shift
            ;;
        --no-turbo)
            NO_TURBO="$2"
            shift
            shift
            ;;
        --hwp-dynamic-boost)
            HWP_DYNAMIC_BOOST="$2"
            shift
            shift
            ;;
        --min-perf-pct)
            MIN_PERF_PCT="$2"
            shift
            shift
            ;;
        --max-perf-pct)
            MAX_PERF_PCT="$2"
            shift
            shift
            ;;
        --energy-efficiency)
            ENERGY_EFFICIENCY="$2"
            shift
            shift
            ;;
        --nosmt)
            NOSMT="$2"
            shift
            shift
            ;;
        --help)
            show_usage
            exit 0
            ;;
        *)
            echo "Unknown parameter: $1"
            show_usage
            exit 1
            ;;
    esac
done

# Set scaling governor
if [[ -n "$GOVERNOR" ]]; then
    for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
        echo "$GOVERNOR" > "$cpu"
    done
fi

# Set energy performance preference
if [[ -n "$EPP" ]]; then
    for cpu in /sys/devices/system/cpu/cpu*/cpufreq/energy_performance_preference; do
        echo "$EPP" > "$cpu"
    done
fi

# Enable/disable Turbo Boost
if [[ -n "$NO_TURBO" ]]; then
    echo "$NO_TURBO" > /sys/devices/system/cpu/intel_pstate/no_turbo
fi

# Enable/disable HWP dynamic boost [if available]
# Controls the CPU P-States boosting. Allowing intel_pstate to use iowait boosting in the active mode with HWP enabled.
# This parameter may improve performance and reduce latency, but it can also cause regressions. Individual testing on each system is required. Disabled (0) by default.
if [[ -n "$HWP_DYNAMIC_BOOST" ]]; then
    if [[ -f /sys/devices/system/cpu/intel_pstate/hwp_dynamic_boost ]]; then
        echo "$HWP_DYNAMIC_BOOST" > /sys/devices/system/cpu/intel_pstate/hwp_dynamic_boost
    else
        echo "Warning: hwp_dynamic_boost is not supported on this system"
    fi
fi

# Set Min P-state allowed, as % of max supported (highest turbo P-state)
if [[ -n "$MIN_PERF_PCT" ]]; then
    echo "$MIN_PERF_PCT" > /sys/devices/system/cpu/intel_pstate/min_perf_pct
fi

# Set Max P-state allowed, as % of max supported (highest turbo P-state)
if [[ -n "$MAX_PERF_PCT" ]]; then
    echo "$MAX_PERF_PCT" > /sys/devices/system/cpu/intel_pstate/max_perf_pct
fi

# Enable/disable SMT (Hyper-Threading) [if available]
# Controls Hyper-Threading: 'on' enables SMT, 'off' disables it. Affects system performance and power consumption. Enabled (on) by default.
if [[ -n "$NOSMT" ]]; then
    if [[ -f /sys/devices/system/cpu/smt/control ]]; then
        echo "$NOSMT" > /sys/devices/system/cpu/smt/control
    else
        echo "Warning: SMT control is not supported on this system"
    fi
fi

echo "Settings applied: governor=$GOVERNOR, epp=$EPP, no_turbo=$NO_TURBO, hwp_dynamic_boost=$HWP_DYNAMIC_BOOST, min_perf_pct=$MIN_PERF_PCT, max_perf_pct=$MAX_PERF_PCT, nosmt=$NOSMT"
